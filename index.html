<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#667eea">
    <title>Urban Korfball Tactics Board</title>
    <style>
        :root {
            --primary: #667eea;
            --danger: #ef4444;
            --success: #10b981;
            --text: #1a202c;
            --text-light: #718096;
            --bg: #f7fafc;
            --white: #fff;
            --border: #e2e8f0;
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --safe-top: env(safe-area-inset-top, 0px);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; -webkit-user-select: none; user-select: none; }
        html, body { height: 100%; overflow: hidden; overscroll-behavior: none; position: fixed; width: 100%; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); touch-action: manipulation; }
        .app { display: flex; flex-direction: column; height: 100dvh; padding-top: var(--safe-top); }

        .header { background: var(--white); border-bottom: 1px solid var(--border); padding: 6px 12px; display: flex; align-items: center; justify-content: space-between; min-height: 44px; }
        .header h1 { font-size: 14px; font-weight: 600; color: var(--text); }
        .header-btns { display: flex; gap: 6px; }
        .icon-btn { width: 38px; height: 38px; border: none; background: var(--bg); border-radius: 8px; color: var(--text); font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .icon-btn:active { background: var(--border); transform: scale(0.95); }
        .icon-btn:disabled { opacity: 0.35; }

        .canvas-container { flex: 1; display: flex; align-items: center; justify-content: center; padding: 4px; overflow: hidden; background: var(--bg); position: relative; }
        canvas { max-width: 100%; max-height: 100%; border-radius: 8px; touch-action: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

        .frame-bar { position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); background: var(--white); border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.12); padding: 6px 10px; display: none; align-items: center; gap: 8px; }
        .frame-bar.show { display: flex; }
        .frame-info { font-size: 12px; font-weight: 600; color: var(--primary); min-width: 40px; text-align: center; }
        .frame-btn { width: 34px; height: 34px; border: none; background: var(--bg); border-radius: 8px; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .frame-btn:active { transform: scale(0.95); }
        .frame-btn.add { background: var(--success); color: #fff; }
        .frame-btn.del { background: var(--danger); color: #fff; }

        .bottom-bar { background: var(--white); border-top: 1px solid var(--border); padding: 8px 16px; padding-bottom: calc(8px + var(--safe-bottom)); }
        .tool-row { display: flex; justify-content: center; gap: 16px; }
        .tool-btn { width: 70px; height: 50px; border: 2px solid var(--border); background: var(--white); border-radius: 12px; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; color: var(--text); }
        .tool-btn .icon { font-size: 20px; }
        .tool-btn .label { font-size: 10px; font-weight: 600; }
        .tool-btn.active { background: var(--primary); border-color: var(--primary); color: var(--white); }
        .tool-btn:active { transform: scale(0.95); }

        .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 150; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .overlay.open { opacity: 1; visibility: visible; }
        .side-panel { position: fixed; top: 0; right: -300px; width: 280px; max-width: 85vw; height: 100%; background: var(--white); z-index: 200; transition: right 0.3s; display: flex; flex-direction: column; }
        .side-panel.open { right: 0; }
        .panel-header { padding: 16px; padding-top: calc(12px + var(--safe-top)); background: var(--primary); color: var(--white); display: flex; align-items: center; justify-content: space-between; }
        .panel-header h2 { font-size: 17px; font-weight: 600; }
        .close-btn { width: 36px; height: 36px; border: none; background: rgba(255,255,255,0.2); border-radius: 8px; color: var(--white); font-size: 18px; cursor: pointer; }
        .panel-content { flex: 1; overflow-y: auto; padding: 16px; }
        .panel-section { margin-bottom: 20px; }
        .panel-section h3 { font-size: 11px; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; font-weight: 600; }

        .color-grid { display: flex; gap: 8px; flex-wrap: wrap; }
        .color-option { width: 40px; height: 40px; border-radius: 10px; border: 3px solid transparent; cursor: pointer; }
        .color-option.active { border-color: var(--text); transform: scale(1.1); }

        .slider-box { background: var(--bg); border-radius: 10px; padding: 12px; }
        .slider-label { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 8px; }
        .slider { width: 100%; height: 6px; -webkit-appearance: none; background: var(--border); border-radius: 3px; }
        .slider::-webkit-slider-thumb { -webkit-appearance: none; width: 22px; height: 22px; background: var(--primary); border-radius: 50%; }

        .toggle-row { display: flex; align-items: center; justify-content: space-between; background: var(--bg); border-radius: 10px; padding: 12px; }
        .toggle-row span { font-size: 14px; }
        .toggle { width: 50px; height: 28px; background: var(--border); border-radius: 14px; position: relative; cursor: pointer; transition: background 0.3s; }
        .toggle.on { background: var(--primary); }
        .toggle::after { content: ''; position: absolute; width: 24px; height: 24px; background: #fff; border-radius: 50%; top: 2px; left: 2px; transition: left 0.3s; }
        .toggle.on::after { left: 24px; }

        .panel-btn { width: 100%; min-height: 44px; padding: 10px 14px; border: none; background: var(--bg); border-radius: 10px; font-size: 14px; color: var(--text); cursor: pointer; display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .panel-btn:active { background: var(--border); }
        .panel-btn.danger { background: #fee2e2; color: var(--danger); }

        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 300; display: flex; align-items: center; justify-content: center; padding: 20px; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .modal.open { opacity: 1; visibility: visible; }
        .modal-box { background: var(--white); border-radius: 14px; padding: 20px; width: 100%; max-width: 320px; }
        .modal-title { font-size: 17px; font-weight: 600; margin-bottom: 14px; }
        .modal-input { width: 100%; padding: 10px; border: 2px solid var(--border); border-radius: 8px; font-size: 14px; margin-bottom: 10px; }
        .modal-input:focus { outline: none; border-color: var(--primary); }
        textarea.modal-input { min-height: 90px; font-family: monospace; font-size: 11px; resize: none; }
        .modal-btns { display: flex; gap: 10px; margin-top: 14px; }
        .modal-btn { flex: 1; height: 42px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .modal-btn.primary { background: var(--primary); color: var(--white); }
        .modal-btn.secondary { background: var(--bg); color: var(--text); }

        .toast { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%) translateY(60px); background: var(--text); color: var(--white); padding: 10px 20px; border-radius: 8px; font-size: 13px; z-index: 400; opacity: 0; transition: all 0.3s; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    </style>
</head>
<body>
    <div class="app">
        <header class="header">
            <h1>üèôÔ∏è Urban Korfball</h1>
            <div class="header-btns">
                <button class="icon-btn" id="undoBtn">‚Ü©</button>
                <button class="icon-btn" id="redoBtn">‚Ü™</button>
                <button class="icon-btn" id="menuBtn">‚ò∞</button>
            </div>
        </header>
        <div class="canvas-container">
            <canvas id="board"></canvas>
            <div class="frame-bar" id="frameBar">
                <button class="frame-btn" id="prevFrame">‚óÄ</button>
                <span class="frame-info"><span id="curFrame">1</span>/<span id="totalFrames">1</span></span>
                <button class="frame-btn" id="nextFrame">‚ñ∂</button>
                <button class="frame-btn add" id="addFrame">Ôºã</button>
                <button class="frame-btn del" id="delFrame">üóë</button>
            </div>
        </div>
        <div class="bottom-bar">
            <div class="tool-row">
                <button class="tool-btn active" data-tool="select"><span class="icon">‚úã</span><span class="label">MOVE</span></button>
                <button class="tool-btn" data-tool="freehand"><span class="icon">‚úèÔ∏è</span><span class="label">DRAW</span></button>
                <button class="tool-btn" data-tool="eraser"><span class="icon">üßΩ</span><span class="label">ERASE</span></button>
            </div>
        </div>
    </div>

    <div class="overlay" id="overlay"></div>
    <div class="side-panel" id="sidePanel">
        <div class="panel-header"><h2>Settings</h2><button class="close-btn" id="closePanel">‚úï</button></div>
        <div class="panel-content">
            <div class="panel-section">
                <h3>Pen Color</h3>
                <div class="color-grid">
                    <button class="color-option active" data-color="#ffffff" style="background:#fff;border:2px solid #ccc"></button>
                    <button class="color-option" data-color="#ef4444" style="background:#ef4444"></button>
                    <button class="color-option" data-color="#3b82f6" style="background:#3b82f6"></button>
                    <button class="color-option" data-color="#10b981" style="background:#10b981"></button>
                    <button class="color-option" data-color="#f59e0b" style="background:#f59e0b"></button>
                    <button class="color-option" data-color="#000000" style="background:#000"></button>
                </div>
            </div>
            <div class="panel-section">
                <h3>Pen Width</h3>
                <div class="slider-box">
                    <div class="slider-label"><span>Width</span><span id="lineWidthValue">3px</span></div>
                    <input type="range" class="slider" id="lineWidth" min="1" max="10" value="3">
                </div>
            </div>
            <div class="panel-section">
                <h3>Animation</h3>
                <div class="toggle-row">
                    <span>Show Frame Controls</span>
                    <div class="toggle" id="frameToggle"></div>
                </div>
                <button class="panel-btn" id="playBtn" style="margin-top:10px">‚ñ∂Ô∏è Play Animation</button>
                <div class="slider-box" style="margin-top:8px">
                    <div class="slider-label"><span>Speed</span><span id="speedValue">1.0s</span></div>
                    <input type="range" class="slider" id="speedSlider" min="200" max="2000" value="1000" step="100">
                </div>
            </div>
            <div class="panel-section">
                <h3>File</h3>
                <button class="panel-btn" id="saveBtn">üíæ Save</button>
                <button class="panel-btn" id="loadBtn">üìÇ Load</button>
                <button class="panel-btn" id="exportBtn">üì∑ Export PNG</button>
            </div>
            <div class="panel-section">
                <h3>Reset</h3>
                <button class="panel-btn" id="clearBtn">üóëÔ∏è Clear Drawings</button>
                <button class="panel-btn danger" id="resetBtn">üîÑ Reset All</button>
            </div>
        </div>
    </div>

    <div class="modal" id="saveModal"><div class="modal-box"><div class="modal-title">üíæ Save</div><textarea class="modal-input" id="saveData" readonly></textarea><div class="modal-btns"><button class="modal-btn secondary" id="closeSaveModal">Cancel</button><button class="modal-btn primary" id="copyBtn">Copy</button></div></div></div>
    <div class="modal" id="loadModal"><div class="modal-box"><div class="modal-title">üìÇ Load</div><textarea class="modal-input" id="loadData" placeholder="Paste data here"></textarea><div class="modal-btns"><button class="modal-btn secondary" id="closeLoadModal">Cancel</button><button class="modal-btn primary" id="loadDataBtn">Load</button></div></div></div>
    <div class="toast" id="toast"></div>

    <script>
        const R_OUT = 9, R_MID = 6, R_IN = 2.5, BORDER = 1.5, PLAYER_R = 0.55;
        const TOTAL = R_OUT * 2 + BORDER * 2;
        const CX = BORDER + R_OUT, CY = BORDER + R_OUT;
        const canvas = document.getElementById('board'), ctx = canvas.getContext('2d');
        let scale, dpr = window.devicePixelRatio || 1;
        let tool = 'select', penColor = '#ffffff', penWidth = 3;
        let frames = [], frameIdx = 0;
        let selected = null, dragging = false, offset = {x:0,y:0}, tempDraw = null;
        let history = [], historyIdx = -1;
        let playing = false, playInterval = null, playSpeed = 1000;

        function createFrame() {
            const sub = R_OUT + 1.1;
            return {
                players: [
                    // Team A (Red) - On Court: 2M + 2F
                    {x:CX-4,y:CY-3,c:'#ef4444',n:'1',g:'M'},{x:CX+2,y:CY-5,c:'#ef4444',n:'2',g:'M'},
                    {x:CX-5,y:CY+2,c:'#ef4444',n:'3',g:'F'},{x:CX+1,y:CY+4,c:'#ef4444',n:'4',g:'F'},
                    // Team A - Subs: 1M + 1F (outside)
                    {x:CX-sub*0.7,y:CY-sub*0.7,c:'#ef4444',n:'5',g:'M'},{x:CX-sub*0.9,y:CY-sub*0.3,c:'#ef4444',n:'6',g:'F'},
                    // Team B (Blue) - On Court: 2M + 2F
                    {x:CX+4,y:CY+3,c:'#3b82f6',n:'1',g:'M'},{x:CX-2,y:CY+5,c:'#3b82f6',n:'2',g:'M'},
                    {x:CX+5,y:CY-2,c:'#3b82f6',n:'3',g:'F'},{x:CX-1,y:CY-4,c:'#3b82f6',n:'4',g:'F'},
                    // Team B - Subs: 1M + 1F (outside)
                    {x:CX+sub*0.7,y:CY+sub*0.7,c:'#3b82f6',n:'5',g:'M'},{x:CX+sub*0.9,y:CY+sub*0.3,c:'#3b82f6',n:'6',g:'F'},
                ],
                ball: {x:CX-3,y:CY-3,c:'#FFEB3B',r:0.4},
                drawings: []
            };
        }

        function init() { frames = [createFrame()]; frameIdx = 0; }

        function resize() {
            const cont = canvas.parentElement, maxW = cont.clientWidth - 8, maxH = cont.clientHeight - 60;
            let sz = Math.min(maxW, maxH);
            dpr = window.devicePixelRatio || 1;
            canvas.width = sz * dpr; canvas.height = sz * dpr;
            canvas.style.width = sz + 'px'; canvas.style.height = sz + 'px';
            scale = sz / TOTAL;
            draw();
        }

        function draw() {
            ctx.setTransform(1,0,0,1,0,0); ctx.scale(dpr,dpr);
            ctx.clearRect(0,0,canvas.width,canvas.height);
            drawCourt();
            const f = frames[frameIdx];
            f.players.forEach(drawPlayer);
            drawBall(f.ball);
            f.drawings.forEach(d => drawLine(d.pts,d.c,d.w));
            if (tempDraw) drawLine(tempDraw.pts, penColor, penWidth);
            updFrameDisp();
        }

        function drawCourt() {
            const cx = CX*scale, cy = CY*scale;
            const ro = R_OUT*scale, rm = R_MID*scale, ri = R_IN*scale;

            // Dark background
            const bg = ctx.createRadialGradient(cx,cy,0,cx,cy,ro*1.5);
            bg.addColorStop(0,'#4a5568'); bg.addColorStop(1,'#2d3748');
            ctx.fillStyle = bg; ctx.fillRect(0,0,canvas.width/dpr,canvas.height/dpr);

            // Court surface
            ctx.shadowColor = 'rgba(0,0,0,0.3)'; ctx.shadowBlur = 15; ctx.shadowOffsetY = 4;
            const cg = ctx.createRadialGradient(cx,cy,0,cx,cy,ro);
            cg.addColorStop(0,'#718096'); cg.addColorStop(1,'#4a5568');
            ctx.fillStyle = cg; ctx.beginPath(); ctx.arc(cx,cy,ro,0,Math.PI*2); ctx.fill();
            ctx.shadowColor = 'transparent';

            // Outer circle (9m)
            ctx.strokeStyle = '#fff'; ctx.lineWidth = 4; ctx.beginPath(); ctx.arc(cx,cy,ro,0,Math.PI*2); ctx.stroke();

            // Middle circle (6m) - dashed
            ctx.setLineDash([10,6]); ctx.lineWidth = 3; ctx.beginPath(); ctx.arc(cx,cy,rm,0,Math.PI*2); ctx.stroke(); ctx.setLineDash([]);

            // Inner circle (2.5m)
            ctx.lineWidth = 3; ctx.beginPath(); ctx.arc(cx,cy,ri,0,Math.PI*2); ctx.stroke();
            ctx.fillStyle = 'rgba(255,255,255,0.08)'; ctx.beginPath(); ctx.arc(cx,cy,ri,0,Math.PI*2); ctx.fill();

            // Korf at center
            ctx.beginPath(); ctx.arc(cx,cy,0.5*scale,0,Math.PI*2); ctx.fillStyle='#D4A017'; ctx.fill();
            ctx.strokeStyle='#8B6914'; ctx.lineWidth=3; ctx.stroke();
            ctx.beginPath(); ctx.arc(cx,cy,0.25*scale,0,Math.PI*2); ctx.strokeStyle='#000'; ctx.lineWidth=2; ctx.stroke();

        }

        function drawPlayer(p) {
            const x = p.x*scale, y = p.y*scale, r = PLAYER_R*scale;
            // Shadow
            ctx.fillStyle = 'rgba(0,0,0,0.25)';
            if (p.g==='M') { ctx.beginPath(); ctx.arc(x+2,y+2,r,0,Math.PI*2); ctx.fill(); }
            else { ctx.fillRect(x-r+2,y-r+2,r*2,r*2); }
            // Player
            ctx.fillStyle = p.c; ctx.strokeStyle = '#fff'; ctx.lineWidth = 2;
            if (p.g==='M') { ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); ctx.stroke(); }
            else { ctx.fillRect(x-r,y-r,r*2,r*2); ctx.strokeRect(x-r,y-r,r*2,r*2); }
            ctx.fillStyle = '#fff'; ctx.font = `bold ${r*1.4}px Arial`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText(p.n, x, y+1);
        }

        function drawBall(b) {
            const x = b.x*scale, y = b.y*scale, r = b.r*scale;
            ctx.fillStyle = 'rgba(0,0,0,0.25)'; ctx.beginPath(); ctx.arc(x+2,y+2,r,0,Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fillStyle = b.c; ctx.fill();
            ctx.strokeStyle = '#000'; ctx.lineWidth = 2; ctx.stroke();
        }

        function drawLine(pts,c,w) {
            if (pts.length<2) return;
            ctx.strokeStyle = c; ctx.lineWidth = w; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
            ctx.beginPath(); ctx.moveTo(pts[0].x,pts[0].y);
            for (let i=1;i<pts.length-1;i++) { const xc=(pts[i].x+pts[i+1].x)/2, yc=(pts[i].y+pts[i+1].y)/2; ctx.quadraticCurveTo(pts[i].x,pts[i].y,xc,yc); }
            ctx.lineTo(pts[pts.length-1].x,pts[pts.length-1].y); ctx.stroke();
        }

        function updFrameDisp() { document.getElementById('curFrame').textContent=frameIdx+1; document.getElementById('totalFrames').textContent=frames.length; }

        function getPos(e) {
            const rect = canvas.getBoundingClientRect(), scX = (canvas.width/dpr)/rect.width, scY = (canvas.height/dpr)/rect.height;
            const cx = e.touches ? e.touches[0].clientX : e.clientX, cy = e.touches ? e.touches[0].clientY : e.clientY;
            return {x:(cx-rect.left)*scX, y:(cy-rect.top)*scY};
        }

        function hit(pos,obj,r) { return Math.hypot(pos.x-obj.x*scale, pos.y-obj.y*scale) <= r*scale*1.5; }

        function onStart(e) {
            if (playing) return;
            e.preventDefault(); const pos = getPos(e); const f = frames[frameIdx];
            if (tool==='select') {
                if (hit(pos,f.ball,f.ball.r)) { selected=f.ball; dragging=true; offset={x:pos.x-f.ball.x*scale,y:pos.y-f.ball.y*scale}; return; }
                for (const p of f.players) if (hit(pos,p,PLAYER_R)) { selected=p; dragging=true; offset={x:pos.x-p.x*scale,y:pos.y-p.y*scale}; return; }
            } else if (tool==='freehand') { tempDraw={pts:[pos]}; }
            else if (tool==='eraser') { erase(pos); }
        }

        function onMove(e) {
            if (playing) return;
            e.preventDefault(); const pos = getPos(e);
            if (tool==='select' && dragging && selected) { selected.x=(pos.x-offset.x)/scale; selected.y=(pos.y-offset.y)/scale; draw(); }
            else if (tool==='freehand' && tempDraw) { const last=tempDraw.pts[tempDraw.pts.length-1]; if(Math.hypot(pos.x-last.x,pos.y-last.y)>2){tempDraw.pts.push(pos);draw();} }
            else if (tool==='eraser' && (e.buttons===1||e.touches)) { erase(pos); }
        }

        function onEnd(e) {
            if (playing) return;
            e.preventDefault();
            if (tool==='select' && dragging) saveHist();
            if (tool==='freehand' && tempDraw && tempDraw.pts.length>1) { frames[frameIdx].drawings.push({pts:tempDraw.pts,c:penColor,w:penWidth}); saveHist(); }
            dragging=false; selected=null; tempDraw=null; draw();
        }

        function erase(pos) {
            const f = frames[frameIdx], before = f.drawings.length;
            f.drawings = f.drawings.filter(d=>!d.pts.some(p=>Math.hypot(p.x-pos.x,p.y-pos.y)<25));
            if (f.drawings.length!==before) { saveHist(); draw(); }
        }

        let lastTap = 0;
        function onDblTap(e) {
            if (playing) return;
            const now = Date.now();
            if (now-lastTap<300) { const pos=getPos(e); for(const p of frames[frameIdx].players) if(hit(pos,p,PLAYER_R)){const n=prompt('Number:',p.n);if(n!==null&&n.trim()){p.n=n.trim();saveHist();draw();}return;} }
            lastTap = now;
        }

        function saveHist() { history=history.slice(0,historyIdx+1); history.push(JSON.parse(JSON.stringify(frames))); historyIdx++; if(history.length>50){history.shift();historyIdx--;} updHist(); }
        function undo() { if(historyIdx>0){historyIdx--;frames=JSON.parse(JSON.stringify(history[historyIdx]));if(frameIdx>=frames.length)frameIdx=frames.length-1;draw();updHist();} }
        function redo() { if(historyIdx<history.length-1){historyIdx++;frames=JSON.parse(JSON.stringify(history[historyIdx]));draw();updHist();} }
        function updHist() { document.getElementById('undoBtn').disabled=historyIdx<=0; document.getElementById('redoBtn').disabled=historyIdx>=history.length-1; }

        function addFrame() { if(playing)return; frames.push(JSON.parse(JSON.stringify(frames[frameIdx]))); frameIdx=frames.length-1; saveHist(); draw(); toast('Frame added'); }
        function delFrame() { if(playing||frames.length<=1)return; frames.splice(frameIdx,1); if(frameIdx>=frames.length)frameIdx=frames.length-1; saveHist(); draw(); toast('Frame deleted'); }
        function prevFrame() { if(frameIdx>0){frameIdx--;draw();} }
        function nextFrame() { if(frameIdx<frames.length-1){frameIdx++;draw();} }

        function startPlay() { if(playing||frames.length<=1)return; playing=true; togglePanel(false); document.getElementById('playBtn').textContent='‚è∏Ô∏è Stop'; if(frameIdx>=frames.length-1)frameIdx=0; playInterval=setInterval(()=>{frameIdx++;if(frameIdx>=frames.length)frameIdx=0;draw();},playSpeed); }
        function stopPlay() { playing=false; if(playInterval){clearInterval(playInterval);playInterval=null;} document.getElementById('playBtn').textContent='‚ñ∂Ô∏è Play Animation'; }

        function toast(m) { const t=document.getElementById('toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1500); }
        function togglePanel(o) { document.getElementById('sidePanel').classList.toggle('open',o); document.getElementById('overlay').classList.toggle('open',o); }

        canvas.addEventListener('touchstart',e=>{onDblTap(e);onStart(e);},{passive:false});
        canvas.addEventListener('touchmove',onMove,{passive:false});
        canvas.addEventListener('touchend',onEnd,{passive:false});
        canvas.addEventListener('mousedown',e=>{onDblTap(e);onStart(e);});
        canvas.addEventListener('mousemove',onMove);
        canvas.addEventListener('mouseup',onEnd);
        canvas.addEventListener('mouseleave',onEnd);

        document.querySelectorAll('.tool-btn').forEach(b=>b.addEventListener('click',()=>{document.querySelectorAll('.tool-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active');tool=b.dataset.tool;}));
        document.querySelectorAll('.color-option').forEach(b=>b.addEventListener('click',()=>{document.querySelectorAll('.color-option').forEach(x=>x.classList.remove('active'));b.classList.add('active');penColor=b.dataset.color;}));
        document.getElementById('menuBtn').addEventListener('click',()=>togglePanel(true));
        document.getElementById('closePanel').addEventListener('click',()=>togglePanel(false));
        document.getElementById('overlay').addEventListener('click',()=>togglePanel(false));
        document.getElementById('lineWidth').addEventListener('input',e=>{penWidth=parseInt(e.target.value);document.getElementById('lineWidthValue').textContent=penWidth+'px';});
        document.getElementById('undoBtn').addEventListener('click',undo);
        document.getElementById('redoBtn').addEventListener('click',redo);
        document.getElementById('prevFrame').addEventListener('click',prevFrame);
        document.getElementById('nextFrame').addEventListener('click',nextFrame);
        document.getElementById('addFrame').addEventListener('click',addFrame);
        document.getElementById('delFrame').addEventListener('click',delFrame);
        document.getElementById('playBtn').addEventListener('click',()=>{playing?stopPlay():startPlay();});
        document.getElementById('speedSlider').addEventListener('input',e=>{playSpeed=parseInt(e.target.value);document.getElementById('speedValue').textContent=(playSpeed/1000).toFixed(1)+'s';if(playing){stopPlay();startPlay();}});
        document.getElementById('frameToggle').addEventListener('click',function(){this.classList.toggle('on');document.getElementById('frameBar').classList.toggle('show',this.classList.contains('on'));});
        document.getElementById('clearBtn').addEventListener('click',()=>{togglePanel(false);frames[frameIdx].drawings=[];saveHist();draw();toast('Cleared');});
        document.getElementById('resetBtn').addEventListener('click',()=>{togglePanel(false);if(confirm('Reset all?')){stopPlay();init();history=[];historyIdx=-1;saveHist();draw();toast('Reset');}});
        document.getElementById('saveBtn').addEventListener('click',()=>{togglePanel(false);document.getElementById('saveData').value=JSON.stringify(frames);document.getElementById('saveModal').classList.add('open');});
        document.getElementById('closeSaveModal').addEventListener('click',()=>document.getElementById('saveModal').classList.remove('open'));
        document.getElementById('copyBtn').addEventListener('click',()=>{navigator.clipboard.writeText(document.getElementById('saveData').value);document.getElementById('saveModal').classList.remove('open');toast('Copied!');});
        document.getElementById('loadBtn').addEventListener('click',()=>{togglePanel(false);document.getElementById('loadModal').classList.add('open');});
        document.getElementById('closeLoadModal').addEventListener('click',()=>document.getElementById('loadModal').classList.remove('open'));
        document.getElementById('loadDataBtn').addEventListener('click',()=>{try{stopPlay();frames=JSON.parse(document.getElementById('loadData').value);frameIdx=0;history=[];historyIdx=-1;saveHist();draw();document.getElementById('loadModal').classList.remove('open');document.getElementById('loadData').value='';toast('Loaded!');}catch(e){toast('Invalid data');}});
        document.getElementById('exportBtn').addEventListener('click',()=>{togglePanel(false);const a=document.createElement('a');a.download=`urban-korfball-${Date.now()}.png`;a.href=canvas.toDataURL();a.click();toast('Saved!');});

        window.addEventListener('resize',resize);
        init(); saveHist(); resize();
    </script>
</body>
</html>
